import os
import platform
import re
import gbls
from nvd import NvdCpe, NvdCve
from format_cpe import FormatCpe
from cve_matcher import CVEMatcher
from cpe_matcher import GeotabInventory
import datetime
import sys
import geotab


def main():

    # Download cpe dictionary####################################

    geotab.logger.logit(2, f'Downloading cpe dictionary at time {datetime.datetime.now()}')
    cpe = NvdCpe()
    cpe.download_cpe()
    cpe.read()
    geotab.logger.logit(2, f'Reading cpe to dataframe finished at time {datetime.datetime.now()}')
    #cpe.save()  # save df_cpe4 in pkl file
    geotab.logger.logit(2, f'Saving cpe finished at time {datetime.datetime.now()}')

    # Format cpe to have wfn########################################
    geotab.logger.logit(2, f'Formatting cpe at time {datetime.datetime.now()}')
    df_cpe = cpe.get()  # get a copy of df_cpe4
    format_cpe = FormatCpe()
    format_cpe= FormatCpe()
    formatted_cpe_database = format_cpe.format_cpe_df(df_cpe)  # (columns=['uri','wfn','formatted_string'])
    geotab.logger.logit(2, f'Formatting cpe finished, mapped asset to cpe at time {datetime.datetime.now()}')

    # Find cpes mapped to geotab assets ##########################
    geotab_inventory = GeotabInventory(formatted_cpe_database)
    # read list of all assets in Geotab
    geotab_inventory.update_assets_list()
    # clean assets name, vendor and version
    geotab_inventory.format_assets()
    df_assets = geotab_inventory.get_assets()
    geotab.logger.logit(2, f'Assigning assets a cpe finished at time {datetime.datetime.now()}')

    # Download CVEs for last seven days ###########################
    geotab.logger.logit(2, f'Downloading CVE dictinary for last seven days at {datetime.datetime.now()}')
    cve_database = NvdCve()
    cve_database.download_cve()
    geotab.logger.logit(2, f'Downloaded CVE dictinary for last seven days at {datetime.datetime.now()}')
    cve_database.read()
    geotab.logger.logit(2, f'Read CVEs for the previous day at {datetime.datetime.now()}')
    cve_database.save()
    geotab.logger.logit(2, f'Saved CVEs for the previous day at {datetime.datetime.now()}')
    cve_database.load()
    df_cves = cve_database.get()

    # Find cves for assets ##########################################
    geotab.logger.logit(2, f'Finding matched CVEs to Geotab assets at {datetime.datetime.now()}')
    cve_matcher = CVEMatcher(df_assets, df_cves)
    cve_matcher.find_matched_cves_to_assets()
    geotab.logger.logit(2, f'Found matched CVEs to Geotab assets at {datetime.datetime.now()}')
    cve_matcher.save_matched_cves()
    cve_matcher.save_matched_assets()

    geotab.logger.logit(2, f'Saved matched CVEs to Geotab assets in GBQ at {datetime.datetime.now()}')
    return


if __name__ == '__main__':
    try:
        geotab.logger.logit(status=1, message=f'Starting, vulnerability management, finding mached nvd cves.')
        main()
        geotab.logger.logit(status=1, message=f'Finished, vulnerability management, finding mached nvd cves.')
    except Exception as e:
        geotab.logger.script_execution_status(e)
    else:
        geotab.logger.script_execution_status()

